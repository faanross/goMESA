<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head><script src="/goMESA/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=goMESA/livereload" data-no-instant defer></script>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="
  3.1. Overview (Server &amp; Agent)
  #

goMESA follows a client-server model where multiple Agents connect back to a central C2 Server using NTP as the communication channel.

  3.2. Server Component
  #


Responsibilities: Listens on UDP port 123, serves legitimate NTP requests, identifies and processes agent communications, manages agent state, queues and sends commands, receives and stores results.
Database: Stores agent metadata (IP, OS, tags, status), command history, and outputs. Supports SQLite: Default, file-based, portable, suitable for smaller deployments.
OS Compatibility &amp; Requirements: Written in Go, compiles cross-platform (Linux, macOS, Windows, BSD). Requires root/administrator privileges to bind to UDP port 123. Depends on libpcap/Npcap for network operations if running agent-like functions, though primarily needs port access.


  3.3. Agent Component
  #


Responsibilities: Establishes covert communication, mimics a legitimate NTP client, listens for commands via packet capture, executes commands using the system shell, and returns results chunked within NTP packets.
System Integration: Detects host OS (Windows, Linux, macOS), identifies network configuration, modifies system NTP settings to point to the C2 server (e.g., Windows Time service, /etc/ntp.conf).
Packet Capture: Uses libpcap/Npcap via gopacket to passively sniff for NTP packets from the C2 server destined for its IP address, avoiding conflicts with the system&rsquo;s network stack.
Cross-Platform Compatibility: Tailored implementations for:

Windows: Integrates with Windows Time service, uses cmd.exe.
Linux: Modifies NTP config (e.g., ntp.conf, timesyncd.conf), uses /bin/sh.
macOS: Modifies macOS time service settings, uses /bin/sh. Requires root/administrator privileges for installation and packet capture.




  3.4. Communication Protocol
  #

goMESA layers its C2 protocol over standard NTP.">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="http://localhost:1313/goMESA/docs/architecture/">
  <meta property="og:site_name" content="goMESA Documentation">
  <meta property="og:title" content="Architecture">
  <meta property="og:description" content="3.1. Overview (Server &amp; Agent) # goMESA follows a client-server model where multiple Agents connect back to a central C2 Server using NTP as the communication channel.
3.2. Server Component # Responsibilities: Listens on UDP port 123, serves legitimate NTP requests, identifies and processes agent communications, manages agent state, queues and sends commands, receives and stores results. Database: Stores agent metadata (IP, OS, tags, status), command history, and outputs. Supports SQLite: Default, file-based, portable, suitable for smaller deployments. OS Compatibility &amp; Requirements: Written in Go, compiles cross-platform (Linux, macOS, Windows, BSD). Requires root/administrator privileges to bind to UDP port 123. Depends on libpcap/Npcap for network operations if running agent-like functions, though primarily needs port access. 3.3. Agent Component # Responsibilities: Establishes covert communication, mimics a legitimate NTP client, listens for commands via packet capture, executes commands using the system shell, and returns results chunked within NTP packets. System Integration: Detects host OS (Windows, Linux, macOS), identifies network configuration, modifies system NTP settings to point to the C2 server (e.g., Windows Time service, /etc/ntp.conf). Packet Capture: Uses libpcap/Npcap via gopacket to passively sniff for NTP packets from the C2 server destined for its IP address, avoiding conflicts with the systemâ€™s network stack. Cross-Platform Compatibility: Tailored implementations for: Windows: Integrates with Windows Time service, uses cmd.exe. Linux: Modifies NTP config (e.g., ntp.conf, timesyncd.conf), uses /bin/sh. macOS: Modifies macOS time service settings, uses /bin/sh. Requires root/administrator privileges for installation and packet capture. 3.4. Communication Protocol # goMESA layers its C2 protocol over standard NTP.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="website">
<title>Architecture | goMESA Documentation</title>
<link rel="icon" href="/goMESA/favicon.png" >
<link rel="manifest" href="/goMESA/manifest.json">
<link rel="canonical" href="http://localhost:1313/goMESA/docs/architecture/">
<link rel="stylesheet" href="/goMESA/book.min.434035e7885c7f5d12818bd9f111cf1a0925c6fb78382667381c3d5eda3fb4f1.css" integrity="sha256-Q0A154hcf10SgYvZ8RHPGgklxvt4OCZnOBw9Xto/tPE=" crossorigin="anonymous">
  <script defer src="/goMESA/fuse.min.js"></script>
  <script defer src="/goMESA/en.search.min.d8c67d95ca988dd98bfc09a32fd04dc3796e3e5207d5173359915e91604b1462.js" integrity="sha256-2MZ9lcqYjdmL/AmjL9BNw3luPlIH1RczWZFekWBLFGI=" crossorigin="anonymous"></script>
<link rel="alternate" type="application/rss+xml" href="http://localhost:1313/goMESA/docs/architecture/index.xml" title="goMESA Documentation" />
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/goMESA/"><span>goMESA Documentation</span>
  </a>
</h2>


<div class="book-search hidden">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>















  
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/goMESA/docs/introduction/" class="">Introduction</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/goMESA/docs/theory_concepts/" class="">Theory and Concepts</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/goMESA/docs/architecture/" class="active">Architecture</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/goMESA/docs/setup/" class="">Setup and Installation</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/goMESA/docs/guide/" class="">User Guide</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/goMESA/docs/features/" class="">Features</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>














</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/goMESA/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>Architecture</h3>

  <label for="toc-control">
    
    <img src="/goMESA/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#31-overview-server--agent">3.1. Overview (Server &amp; Agent)</a></li>
    <li><a href="#32-server-component">3.2. Server Component</a></li>
    <li><a href="#33-agent-component">3.3. Agent Component</a></li>
    <li><a href="#34-communication-protocol">3.4. Communication Protocol</a>
      <ul>
        <li><a href="#341-packet-structure">3.4.1. Packet Structure</a></li>
        <li><a href="#342-packet-types">3.4.2. Packet Types</a></li>
        <li><a href="#343-command-encoding--chunking">3.4.3. Command Encoding &amp; Chunking</a></li>
        <li><a href="#344-encryption-xor-aes-256-gcm">3.4.4. Encryption (XOR, AES-256-GCM)</a></li>
        <li><a href="#345-handshaking">3.4.5. Handshaking</a></li>
      </ul>
    </li>
    <li><a href="#35-communication-flow-summary">3.5. Communication Flow Summary</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown book-article"><h2 id="31-overview-server--agent">
  3.1. Overview (Server &amp; Agent)
  <a class="anchor" href="#31-overview-server--agent">#</a>
</h2>
<p>goMESA follows a client-server model where multiple Agents connect back to a central C2 Server using NTP as the communication channel.</p>
<h2 id="32-server-component">
  3.2. Server Component
  <a class="anchor" href="#32-server-component">#</a>
</h2>
<ul>
<li><strong>Responsibilities</strong>: Listens on UDP port 123, serves legitimate NTP requests, identifies and processes agent communications, manages agent state, queues and sends commands, receives and stores results.</li>
<li><strong>Database</strong>: Stores agent metadata (IP, OS, tags, status), command history, and outputs. Supports SQLite: Default, file-based, portable, suitable for smaller deployments.</li>
<li><strong>OS Compatibility &amp; Requirements</strong>: Written in Go, compiles cross-platform (Linux, macOS, Windows, BSD). Requires root/administrator privileges to bind to UDP port 123. Depends on libpcap/Npcap for network operations if running agent-like functions, though primarily needs port access.</li>
</ul>
<h2 id="33-agent-component">
  3.3. Agent Component
  <a class="anchor" href="#33-agent-component">#</a>
</h2>
<ul>
<li><strong>Responsibilities</strong>: Establishes covert communication, mimics a legitimate NTP client, listens for commands via packet capture, executes commands using the system shell, and returns results chunked within NTP packets.</li>
<li><strong>System Integration</strong>: Detects host OS (Windows, Linux, macOS), identifies network configuration, modifies system NTP settings to point to the C2 server (e.g., Windows Time service, <code>/etc/ntp.conf</code>).</li>
<li><strong>Packet Capture</strong>: Uses libpcap/Npcap via gopacket to passively sniff for NTP packets from the C2 server destined for its IP address, avoiding conflicts with the system&rsquo;s network stack.</li>
<li><strong>Cross-Platform Compatibility</strong>: Tailored implementations for:
<ul>
<li><strong>Windows</strong>: Integrates with Windows Time service, uses <code>cmd.exe</code>.</li>
<li><strong>Linux</strong>: Modifies NTP config (e.g., <code>ntp.conf</code>, <code>timesyncd.conf</code>), uses <code>/bin/sh</code>.</li>
<li><strong>macOS</strong>: Modifies macOS time service settings, uses <code>/bin/sh</code>. Requires root/administrator privileges for installation and packet capture.</li>
</ul>
</li>
</ul>
<h2 id="34-communication-protocol">
  3.4. Communication Protocol
  <a class="anchor" href="#34-communication-protocol">#</a>
</h2>
<p>goMESA layers its C2 protocol over standard NTP.</p>
<h3 id="341-packet-structure">
  3.4.1. Packet Structure
  <a class="anchor" href="#341-packet-structure">#</a>
</h3>
<pre tabindex="0"><code>+----------------+---------------+----------------+
| NTP Header     | goMESA Header | Payload        |
| (Standard 48B) | (4 bytes)     | (Variable)     |
+----------------+---------------+----------------+
</code></pre><ul>
<li><strong>NTP Header</strong>: A valid, standard NTP header ensures the packet appears legitimate.</li>
<li><strong>goMESA Header</strong>: A 4-byte identifier placed in a field normally ignored or used for authentication (often within the first optional extension field or appended data not strictly part of the 48B base header, depending on implementation details hinted at). This header indicates the packet type.</li>
<li><strong>Payload</strong>: Encrypted command or response data.</li>
</ul>
<p><em>Note: The exact placement of the goMESA header/payload relative to the 48-byte structure can vary but aims to be ignored by standard NTP implementations.</em></p>
<h3 id="342-packet-types">
  3.4.2. Packet Types
  <a class="anchor" href="#342-packet-types">#</a>
</h3>
<p>The 4-byte goMESA header signifies the purpose:</p>
<ul>
<li><code>PING</code>: Agent heartbeat/check-in.</li>
<li><code>COMU</code>: Command chunk (part of a larger command, Unfinished).</li>
<li><code>COMD</code>: Command chunk (final part of a command, Done).</li>
<li><code>COMO</code>: Command Output chunk.</li>
<li><code>KILL</code>: Agent termination signal.</li>
</ul>
<h3 id="343-command-encoding--chunking">
  3.4.3. Command Encoding &amp; Chunking
  <a class="anchor" href="#343-command-encoding--chunking">#</a>
</h3>
<p>Commands and large outputs are broken into smaller chunks to fit within reasonable packet sizes. Each chunk is sent in a separate NTP-like packet, marked with the appropriate header (<code>COMU</code>, <code>COMD</code>, <code>COMO</code>). The receiving end reassembles these chunks based on sequence and the final <code>COMD</code> marker.</p>
<h3 id="344-encryption-xor-aes-256-gcm">
  3.4.4. Encryption (XOR, AES-256-GCM)
  <a class="anchor" href="#344-encryption-xor-aes-256-gcm">#</a>
</h3>
<p>Payloads are encrypted for obfuscation and security:</p>
<ul>
<li><strong>XOR</strong>: Simple, fast obfuscation using a fixed key. Easily reversible if the key is known but prevents casual inspection.</li>
<li><strong>AES-256-GCM</strong>: Stronger, authenticated encryption. Requires a shared key and proper nonce management to prevent replay attacks.</li>
</ul>
<h3 id="345-handshaking">
  3.4.5. Handshaking
  <a class="anchor" href="#345-handshaking">#</a>
</h3>
<p>The initial <code>PING</code> packet sent by a new agent acts as a registration/handshake, allowing the server to add the agent to its database. Subsequent <code>PING</code>s serve as heartbeats.</p>
<h2 id="35-communication-flow-summary">
  3.5. Communication Flow Summary
  <a class="anchor" href="#35-communication-flow-summary">#</a>
</h2>
<ol>
<li><strong>Agent -&gt; Server (NTP)</strong>: Heartbeats (<code>PING</code>), Command Outputs (<code>COMO</code>).</li>
<li><strong>Server -&gt; Agent (NTP)</strong>: Commands (<code>COMU</code>/<code>COMD</code>), Kill signals (<code>KILL</code>).</li>
<li><strong>Web Client &lt;-&gt; Server (WebSocket/HTTP)</strong>:</li>
</ol>
<ul>
<li>Client sends requests (view agents, execute command, ping, kill, group) via WebSocket messages or REST API calls.</li>
<li>Server pushes real-time updates (agent list, status changes, command results) to clients via WebSocket.</li>
<li>Server serves initial web application files via HTTP.</li>
</ul>
<p><a href="../setup/">NEXT</a></p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#31-overview-server--agent">3.1. Overview (Server &amp; Agent)</a></li>
    <li><a href="#32-server-component">3.2. Server Component</a></li>
    <li><a href="#33-agent-component">3.3. Agent Component</a></li>
    <li><a href="#34-communication-protocol">3.4. Communication Protocol</a>
      <ul>
        <li><a href="#341-packet-structure">3.4.1. Packet Structure</a></li>
        <li><a href="#342-packet-types">3.4.2. Packet Types</a></li>
        <li><a href="#343-command-encoding--chunking">3.4.3. Command Encoding &amp; Chunking</a></li>
        <li><a href="#344-encryption-xor-aes-256-gcm">3.4.4. Encryption (XOR, AES-256-GCM)</a></li>
        <li><a href="#345-handshaking">3.4.5. Handshaking</a></li>
      </ul>
    </li>
    <li><a href="#35-communication-flow-summary">3.5. Communication Flow Summary</a></li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












